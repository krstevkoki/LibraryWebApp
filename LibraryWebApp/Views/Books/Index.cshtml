@*@model IEnumerable<LibraryWebApp.Models.Book>*@

@using PagedList;
@using PagedList.Mvc;
@model PagedList.IPagedList<LibraryWebApp.Models.Book>

@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div id="container" class="container">
    <div class="row bg-primary">
        <div class="col-sm-12 text-center">
            <h3>B O O K S</h3>
        </div>
    </div>

    <div class="clearfix">
        <br/>
    </div>

    <div class="row">
        <div class="col-xs-12 col-sm-4 col-md-4 col-lg-4 navbar-right">
            <div class="form-inline">
                <div class="form-group">
                    <label for="search" style="cursor: pointer;">Search for a book:</label>
                    <input id="search" type="search" placeholder="Enter the book title" class="form-control" name="query"/>
                </div>
            </div>
        </div>
    </div>

    <div class="clearfix">
        <br/>
        <br/>
    </div>

    <div class="row">
        <div id="no-results-message" class="alert alert-danger text-danger"></div>
        <div id="basic">
            @foreach (var book in Model)
            {
                <div class="column" style="background-color: lightcyan">
                    <img src="@book.CoverURL" class="img-responsive center-block"/>

                    <p class="text-center">
                        <strong>Book Title: @book.Title</strong>
                    </p>

                    @foreach (var author in book.Authors)
                    {
                        <p class="text-center">
                            <strong>Author:</strong> <a href="/Authors/Details/@author.Id">@author.Name</a>
                        </p>
                    }

                    <p class="text-center">
                        @if (User.IsInRole("Admin") || User.IsInRole("Staff"))
                        {
                            <a href="/Books/Edit/@book.Id" class="btn btn-primary">Edit</a>
                            <a href="/Books/Delete/@book.Id" class="btn btn-primary">Delete </a>
                        }
                        <a href="/Books/Details/@book.Id" class="btn btn-primary">Details</a>
                    </p>
                </div>
            }
        </div>
        <div id="results"></div>
    </div>


    <div class="pagination">
        <strong>Page @(Model.PageCount < Model.PageNumber ? 0 : Model.PageNumber) / @Model.PageCount</strong>
        @Html.PagedListPager(Model, page => Url.Action("Index", new { page = page }))
    </div>

</div>

@section styles
{
    <link rel="stylesheet" type="text/css" href="@Href("~/Content/BooksIndexCss.css")"/>
}

@section scripts
{
    <script type="text/javascript">
        var userRole = "@ViewBag.UserRole";
        $(document).ready(function () {

            $("#results, #no-results-message").hide();

            $("#search").on("keyup",
                function() {
                    var query = $(this).val().trim();
                    $("#basic, #results, #no-results-message").hide();
                    $("#results, #no-results-message").empty();

                    if (query !== "") {
                        $.post("/Books/Search",
                            { query: query },
                            function (response) {
                                if (response.hasOwnProperty("StatusCode")) {
                                    $("#no-results-message").append(
                                        '<span class="glyphicon glyphicon-info-sign"></span>' +
                                        '<span>'+ response.StatusDescription +'</span>'
                                    );
                                    $("#no-results-message").show();
                                    return;
                                }

                                for (var i = 0; i < response.length; ++i) {
                                    $("#results").append(
                                        '<div class="column column-result" style="background-color: lightcyan">' +
                                        '<img src="' + response[i].CoverUrl + '" class="img-responsive center-block"/>' +
                                        '<p class="text-center">' +
                                        '<strong>Book Title: ' + response[i].Title + '</strong>' +
                                        '</p>' +
                                        '<p class="text-center">' +
                                        '<a href="/Books/Details/' + response[i].Id + '" class="btn btn-primary">Details</a>' +
                                        '</p>' +
                                        '</div>');

                                    if (userRole === "Admin" || userRole === "Staff")
                                        $("#results p.text-center:last").prepend(
                                            '<a href="/Books/Edit/' + response[i].Id + '" class="btn btn-primary btn-result">Edit</a>' +
                                            '<a href="/Books/Delete/' + response[i].Id + '" class="btn btn-primary btn-result">Delete</a>'
                                        );

                                }
                            });
                        $("#results").fadeIn(500,
                            function() {
                                $(this).show();
                            });
                        $("#no-results-message").hide();
                    } else {
                        $("#results, #no-results-message").empty();
                        $("#results, #no-results-message").hide();
                        $("#basic").fadeIn(500,
                            function() {
                                $(this).show();
                            });
                    }
                });
        });
    </script>
}